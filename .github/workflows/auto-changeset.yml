name: ðŸ¤– Auto Changeset

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.changeset/**'
      - 'CHANGELOG.md'
      - 'package.json'

jobs:
  auto-changeset:
    name: ðŸ¤– Generate Changeset from Commits
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Check for existing changesets
        id: check_changesets
        run: |
          # Count changeset files (excluding config.json and README.md)
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" | wc -l)
          echo "changeset_count=$CHANGESET_COUNT" >> $GITHUB_OUTPUT
          echo "Found $CHANGESET_COUNT pending changesets"

      - name: ðŸ“ Generate Changeset from Commit
        if: steps.check_changesets.outputs.changeset_count == '0'
        run: |
          # Get the commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          
          echo "Commit message: $COMMIT_MSG"
          
          # Determine version bump type from commit message
          # Default to patch unless specified
          if echo "$COMMIT_MSG" | grep -qiE "^(feat|feature)(\(.+\))?!:|BREAKING CHANGE"; then
            BUMP_TYPE="major"
          elif echo "$COMMIT_MSG" | grep -qiE "^(feat|feature)(\(.+\))?:"; then
            BUMP_TYPE="minor"
          else
            BUMP_TYPE="patch"
          fi
          
          echo "Bump type: $BUMP_TYPE"
          
          # Clean up commit message for changelog
          # Remove conventional commit prefixes for cleaner changelog
          CLEAN_MSG=$(echo "$COMMIT_MSG" | head -1 | sed -E 's/^(feat|fix|chore|docs|style|refactor|perf|test|build|ci|revert)(\(.+\))?:\s*//i')
          
          # If message is empty after cleanup, use original
          if [ -z "$CLEAN_MSG" ]; then
            CLEAN_MSG=$(echo "$COMMIT_MSG" | head -1)
          fi
          
          # Capitalize first letter
          CLEAN_MSG="$(echo "${CLEAN_MSG:0:1}" | tr '[:lower:]' '[:upper:]')${CLEAN_MSG:1}"
          
          # Generate unique filename
          FILENAME=".changeset/auto-${COMMIT_SHA}.md"
          
          # Create changeset file using printf to avoid YAML parsing issues
          printf '%s\n' '---' "\"craft\": $BUMP_TYPE" '---' '' "$CLEAN_MSG" > "$FILENAME"
          
          echo "Created changeset: $FILENAME"
          cat "$FILENAME"

      - name: ðŸ“¤ Commit Changeset
        if: steps.check_changesets.outputs.changeset_count == '0'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes to commit
          if git diff --quiet .changeset/; then
            echo "No changeset changes to commit"
            exit 0
          fi
          
          git add .changeset/
          git commit -m "chore: auto-generate changeset [skip ci]"
          git push
