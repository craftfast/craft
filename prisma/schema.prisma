generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
  UNPAID
  EXPIRED
}

enum WebhookEventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model User {
  id                    String                       @id @default(cuid())
  name                  String?
  email                 String                       @unique
  emailVerified         Boolean                      @default(false)
  image                 String?
  // Custom Craft fields
  preferredChatPosition String                       @default("left")
  preferredTheme        String                       @default("system")
  // Personalization settings
  responseTone          String? // default, concise, detailed, encouraging, professional
  customInstructions    String?                      @db.Text
  occupation            String?
  techStack             String?                      @db.Text
  enableMemory          Boolean                      @default(false) // Disabled for cost optimization (was adding 44k tokens per request)
  referenceChatHistory  Boolean                      @default(true)
  enableWebSearch       Boolean                      @default(false)
  enableImageGeneration Boolean                      @default(false)
  // Model preferences
  preferredCodingModel  String?                      @default("anthropic/claude-sonnet-4.5") // User's preferred coding model
  enabledCodingModels   String[]                     @default(["anthropic/claude-haiku-4.5", "anthropic/claude-sonnet-4.5", "openai/gpt-5-mini", "openai/gpt-5.1", "google/gemini-2.5-flash", "google/gemini-3-pro-preview", "x-ai/grok-code-fast-1"]) // Models user has enabled
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  // Better Auth admin plugin fields
  role                  String                       @default("user")
  banned                Boolean?
  banReason             String?
  banExpires            DateTime?
  // Better Auth 2FA plugin field
  twoFactorEnabled      Boolean                      @default(false)
  // Better Auth last login method plugin field
  lastLoginMethod       String?
  // Craft-specific soft delete fields
  deletionScheduledAt   DateTime?
  deletedAt             DateTime?
  // Razorpay Integration fields
  razorpayCustomerId    String?                      @unique
  // Billing information
  billingName           String? // Full name for billing
  billingCountry        String? // Country code (e.g., IN, US)
  billingAddress        Json? // { line1, line2, city, state, postalCode }
  taxId                 String? // GST/VAT/Tax ID number
  taxIdCountry          String? // Country code for Tax ID (e.g., IN, US, GB)
  sendInvoiceEmail      Boolean                      @default(false) // Send invoice email after each purchase
  // Balance system (replaces subscription credits)
  accountBalance        Decimal                      @default(0) @db.Decimal(10, 2)
  // Relations
  accounts              Account[]
  files                 File[]
  passwordHistory       PasswordHistory[]
  paymentTransactions   PaymentTransaction[]
  pendingAccountLinks   PendingAccountLink[]         @relation("PendingAccountLinks")
  projects              Project[]
  sessions              Session[]
  subscription          UserSubscription?
  twofactors            TwoFactor[]
  // Balance transactions
  balanceTransactions   BalanceTransaction[]
  // Memory relations
  memories              UserMemory[]
  // Agent orchestration relations
  agentSessions         AgentSession[]
  // Project settings relations
  projectCollaborations ProjectCollaborator[]        @relation("ProjectCollaborations")
  invitedCollaborators  ProjectCollaborator[]        @relation("InvitedCollaborators")
  uploadedKnowledge     KnowledgeFile[]              @relation("UploadedKnowledge")
  // Environment variables relations
  createdEnvVars        ProjectEnvironmentVariable[] @relation("CreatedEnvVars")
  updatedEnvVars        ProjectEnvironmentVariable[] @relation("UpdatedEnvVars")
  envVarAudits          EnvironmentVariableAudit[]   @relation("EnvVarAudits")
  // Support messages relations
  supportMessages       SupportMessage[]             @relation("UserSupportMessages")
  adminSupportMessages  SupportMessage[]             @relation("AdminSupportMessages")

  @@index([razorpayCustomerId])
  @@map("users")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  scope                 String?
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  createdAt             DateTime  @default(now())
  idToken               String?
  password              String?
  refreshToken          String?
  refreshTokenExpiresAt DateTime?
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, providerId])
  @@unique([providerId, accountId])
  @@map("accounts")
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  ipAddress      String?
  token          String   @unique
  updatedAt      DateTime @updatedAt
  userAgent      String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@map("sessions")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verifications")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String // Hashed password
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("password_history")
}

model PendingAccountLink {
  id                String   @id @default(cuid())
  userId            String
  email             String
  provider          String
  providerAccountId String
  token             String   @unique
  expiresAt         DateTime
  createdAt         DateTime @default(now())
  user              User     @relation("PendingAccountLinks", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([token])
  @@map("pending_account_links")
}

model Project {
  id                            String                       @id @default(cuid())
  name                          String
  description                   String?
  type                          String                       @default("document")
  status                        String                       @default("active")
  visibility                    String                       @default("private")
  userId                        String
  version                       Int                          @default(0)
  generationStatus              String                       @default("template")
  lastCodeUpdateAt              DateTime?
  codeFiles                     Json                         @default("{}")
  // E2B Sandbox fields (Phase 3)
  sandboxId                     String? // E2B sandbox ID for pause/resume
  sandboxPausedAt               DateTime? // Timestamp when sandbox was paused
  lastBackupAt                  DateTime? // Timestamp of last R2 backup
  previewImage                  String? // Screenshot/preview image URL for project thumbnail
  previewImageCapturedAtVersion Int? // Project version when preview image was captured
  // Environment Variables & Custom Views
  environmentVariables          Json                         @default("{}") // Encrypted env vars
  customViews                   Json                         @default("[]") // Array of custom view configs
  // Git & Deployment settings
  gitSettings                   Json                         @default("{}") // Git provider connections
  deploymentSettings            Json                         @default("{}") // Deployment configurations
  createdAt                     DateTime                     @default(now())
  updatedAt                     DateTime                     @updatedAt
  chatMessages                  ChatMessage[]
  fileRecords                   File[]                       @relation("ProjectFiles")
  versions                      ProjectVersion[]
  user                          User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Agent orchestration relations
  agentSessions                 AgentSession[]
  tasks                         Task[]
  // Project settings relations
  collaborators                 ProjectCollaborator[]
  gitConnections                ProjectGitConnection[]
  deployments                   ProjectDeployment[]
  knowledgeFiles                KnowledgeFile[]
  webhooks                      ProjectWebhook[]
  environmentVariablesTable     ProjectEnvironmentVariable[]

  @@index([sandboxId])
  @@map("projects")
}

model File {
  id            String       @id @default(cuid())
  userId        String
  projectId     String?
  chatMessageId String?
  path          String?
  r2Key         String       @unique
  r2Url         String
  fileName      String
  mimeType      String?
  size          Int
  purpose       String       @default("upload")
  version       Int          @default(1)
  isDeleted     Boolean      @default(false)
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  chatMessage   ChatMessage? @relation(fields: [chatMessageId], references: [id])
  project       Project?     @relation("ProjectFiles", fields: [projectId], references: [id])
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([chatMessageId])
  @@index([r2Key])
  @@index([purpose])
  @@index([projectId, path])
  @@index([chatMessageId, createdAt])
  @@map("files")
}

model ChatMessage {
  id          String   @id @default(cuid())
  projectId   String
  role        String
  content     String
  fileChanges Json?
  toolCalls   Json? // Store tool execution data: [{id, name, args, status, result, error, startedAt, completedAt}]
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  files       File[]

  @@index([projectId])
  @@index([projectId, createdAt])
  @@map("chat_messages")
}

model ProjectVersion {
  id            String   @id @default(cuid())
  projectId     String
  version       Int
  name          String?
  codeFiles     Json
  chatMessageId String?
  isBookmarked  Boolean  @default(false)
  isPublished   Boolean  @default(false)
  createdAt     DateTime @default(now())
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId, createdAt])
  @@index([projectId, isBookmarked])
  @@index([projectId, isPublished])
  @@map("project_versions")
}

model ProjectCollaborator {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("viewer") // owner, editor, viewer
  addedBy   String
  addedAt   DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation("ProjectCollaborations", fields: [userId], references: [id], onDelete: Cascade)
  invitedBy User     @relation("InvitedCollaborators", fields: [addedBy], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_collaborators")
}

model ProjectGitConnection {
  id           String    @id @default(cuid())
  projectId    String    @unique
  provider     String // github, gitlab, bitbucket
  repository   String
  branch       String    @default("main")
  accessToken  String // Encrypted
  refreshToken String? // Encrypted
  username     String?
  repoUrl      String?
  connectedAt  DateTime  @default(now())
  lastSyncAt   DateTime?
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([provider])
  @@map("project_git_connections")
}

model ProjectDeployment {
  id           String   @id @default(cuid())
  projectId    String
  provider     String // vercel, netlify, railway, render, aws, digitalocean, heroku
  deploymentId String?
  url          String?
  status       String   @default("active") // active, failed, pending, inactive
  environment  String   @default("production")
  metadata     Json? // Store provider-specific data
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([provider])
  @@index([status])
  @@map("project_deployments")
}

model KnowledgeFile {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  r2Key       String   @unique
  r2Url       String
  mimeType    String
  size        Int
  description String?
  uploadedBy  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader    User     @relation("UploadedKnowledge", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([r2Key])
  @@map("knowledge_files")
}

model ProjectWebhook {
  id              String            @id @default(cuid())
  projectId       String
  url             String
  secret          String // For signing webhook payloads
  events          Json // Array of event types to listen for
  isActive        Boolean           @default(true)
  description     String?
  lastTriggeredAt DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deliveries      WebhookDelivery[]
  project         Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([isActive])
  @@map("project_webhooks")
}

model ProjectEnvironmentVariable {
  id          String                     @id @default(cuid())
  projectId   String
  key         String // Environment variable name (e.g., DATABASE_URL)
  value       String                     @db.Text // Encrypted value if isSecret=true
  isSecret    Boolean                    @default(true) // Whether to encrypt the value
  type        String? // Optional type for validation (string, number, url, email, json)
  description String? // Optional description
  createdBy   String
  updatedBy   String?
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  deletedAt   DateTime? // Soft delete
  project     Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator     User                       @relation("CreatedEnvVars", fields: [createdBy], references: [id], onDelete: Cascade)
  updater     User?                      @relation("UpdatedEnvVars", fields: [updatedBy], references: [id], onDelete: SetNull)
  auditLogs   EnvironmentVariableAudit[]

  @@unique([projectId, key])
  @@index([projectId])
  @@index([key])
  @@index([createdBy])
  @@map("project_environment_variables")
}

model EnvironmentVariableAudit {
  id             String                     @id @default(cuid())
  envVarId       String
  action         String // created, updated, deleted, viewed, key_rotated
  oldValue       String?                    @db.Text // For updates (masked for secrets)
  newValue       String?                    @db.Text // For updates (masked for secrets)
  performedBy    String
  ipAddress      String?
  userAgent      String?
  metadata       Json? // Additional context
  createdAt      DateTime                   @default(now())
  environmentVar ProjectEnvironmentVariable @relation(fields: [envVarId], references: [id], onDelete: Cascade)
  user           User                       @relation("EnvVarAudits", fields: [performedBy], references: [id], onDelete: Cascade)

  @@index([envVarId])
  @@index([performedBy])
  @@index([action])
  @@index([createdAt])
  @@map("environment_variable_audits")
}

model WebhookDelivery {
  id            String         @id @default(cuid())
  webhookId     String
  eventType     String
  payload       Json
  responseCode  Int?
  responseBody  String?
  status        String         @default("pending") // pending, success, failed
  attemptCount  Int            @default(0)
  lastAttemptAt DateTime?
  createdAt     DateTime       @default(now())
  webhook       ProjectWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

model Plan {
  id              String             @id @default(cuid())
  name            String             @unique
  displayName     String
  description     String?
  priceMonthlyUsd Float
  features        Json
  maxProjects     Int?
  monthlyCredits  Int
  isActive        Boolean            @default(true)
  sortOrder       Int                @default(0)
  // Razorpay Integration fields
  razorpayPlanId  String?            @unique
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  subscriptions   UserSubscription[]

  @@index([name])
  @@index([isActive])
  @@index([razorpayPlanId])
  @@map("plans")
}

model UserSubscription {
  id                     String             @id @default(cuid())
  userId                 String             @unique
  planId                 String
  status                 SubscriptionStatus @default(ACTIVE)
  currentPeriodStart     DateTime           @default(now())
  currentPeriodEnd       DateTime
  cancelAtPeriodEnd      Boolean            @default(false)
  cancelledAt            DateTime?
  razorpayOrderId        String?
  razorpayPaymentId      String?
  // Razorpay Integration fields
  razorpaySubscriptionId String?            @unique
  razorpayCustomerId     String?
  monthlyCreditsUsed     Decimal            @default(0) @db.Decimal(10, 2)
  periodCreditsReset     DateTime           @default(now())
  gracePeriodEndsAt      DateTime?
  paymentFailedAt        DateTime?
  // Scheduled plan changes (for downgrades)
  pendingPlanId          String?
  planChangeAt           DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  invoices               Invoice[]
  usageRecords           UsageRecord[]
  plan                   Plan               @relation(fields: [planId], references: [id])
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([gracePeriodEndsAt])
  @@index([razorpaySubscriptionId])
  @@index([razorpayCustomerId])
  @@map("user_subscriptions")
}

model AICreditUsage {
  id              String   @id @default(cuid())
  userId          String
  projectId       String
  model           String
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  providerCostUsd Float // Exact provider cost with no markup
  endpoint        String?
  callType        String   @default("agent")
  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@index([projectId, createdAt])
  @@index([model, createdAt])
  @@index([callType, createdAt])
  @@index([createdAt])
  @@map("ai_credit_usage")
}

model UsageRecord {
  id                  String           @id @default(cuid())
  userId              String
  subscriptionId      String
  billingPeriodStart  DateTime
  billingPeriodEnd    DateTime
  // Credit usage breakdown
  aiCreditsUsed       Decimal          @default(0) @db.Decimal(10, 2)
  sandboxCreditsUsed  Decimal          @default(0) @db.Decimal(10, 2)
  databaseCreditsUsed Decimal          @default(0) @db.Decimal(10, 2)
  storageCreditsUsed  Decimal          @default(0) @db.Decimal(10, 2)
  deployCreditsUsed   Decimal          @default(0) @db.Decimal(10, 2)
  totalCreditsUsed    Decimal          @default(0) @db.Decimal(10, 2)
  // Cost tracking (USD)
  aiCostUsd           Float            @default(0)
  sandboxCostUsd      Float            @default(0)
  databaseCostUsd     Float            @default(0)
  storageCostUsd      Float            @default(0)
  deployCostUsd       Float            @default(0)
  totalCostUsd        Float            @default(0)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  subscription        UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, billingPeriodStart])
  @@index([userId, billingPeriodStart])
  @@index([billingPeriodEnd])
  @@map("usage_records")
}

model Invoice {
  id                 String           @id @default(cuid())
  userId             String
  subscriptionId     String
  invoiceNumber      String           @unique
  status             String           @default("draft")
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  subscriptionFeeUsd Float            @default(0)
  aiUsageCostUsd     Float            @default(0)
  subtotalUsd        Float            @default(0)
  taxUsd             Float            @default(0)
  totalUsd           Float            @default(0)
  currency           String           @default("USD")
  razorpayOrderId    String?
  razorpayPaymentId  String?
  paidAt             DateTime?
  dueDate            DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  subscription       UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([billingPeriodStart])
  @@index([dueDate])
  @@map("invoices")
}

model PaymentTransaction {
  id                String   @id @default(cuid())
  userId            String
  invoiceId         String?
  amount            Float
  currency          String   @default("USD")
  status            String
  paymentMethod     String   @default("razorpay")
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
  failureReason     String?
  metadata          Json?
  // Tax compliance fields
  taxAmount         Float?
  taxRate           Float?
  taxCountryCode    String?
  // Audit fields
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceId])
  @@index([status])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@index([createdAt])
  @@map("payment_transactions")
}

enum BalanceTransactionType {
  TOPUP
  AI_USAGE
  SANDBOX_USAGE
  STORAGE_USAGE
  DATABASE_USAGE
  DEPLOYMENT
}

model BalanceTransaction {
  id            String                 @id @default(cuid())
  userId        String
  type          BalanceTransactionType
  amount        Decimal                @db.Decimal(10, 2) // Positive for credits, negative for debits
  balanceBefore Decimal                @db.Decimal(10, 2)
  balanceAfter  Decimal                @db.Decimal(10, 2)
  description   String
  metadata      Json?
  createdAt     DateTime               @default(now())
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@map("balance_transactions")
}

model WebhookEvent {
  id          String             @id @default(cuid())
  eventId     String             @unique // Razorpay event ID
  eventType   String // "payment.captured", "subscription.cancelled", etc.
  payload     Json
  status      WebhookEventStatus @default(PENDING)
  processedAt DateTime?
  error       String?
  retryCount  Int                @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([eventType])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_events")
}

model VercelIntegration {
  id             String       @id @default(cuid())
  userId         String       @unique
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  vercelUserId   String?
  vercelTeamId   String?
  email          String?
  username       String?
  scopes         String[]
  isActive       Boolean      @default(true)
  lastSyncAt     DateTime?
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deployments    Deployment[]

  @@index([userId])
  @@index([isActive])
  @@map("vercel_integrations")
}

model GitHubIntegration {
  id                    String             @id @default(cuid())
  userId                String             @unique
  accessToken           String
  refreshToken          String?
  tokenExpiresAt        DateTime?
  refreshTokenExpiresAt DateTime?
  installationId        Int? // GitHub App installation ID
  githubUserId          Int
  login                 String
  email                 String?
  name                  String?
  avatarUrl             String?
  scopes                String[]
  isActive              Boolean            @default(true)
  lastSyncAt            DateTime?
  metadata              Json?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  repositories          GitHubRepository[]

  @@index([userId])
  @@index([githubUserId])
  @@index([installationId])
  @@index([isActive])
  @@map("github_integrations")
}

model GitHubRepository {
  id                  String            @id @default(cuid())
  githubIntegrationId String
  projectId           String?
  githubRepoId        Int               @unique
  name                String
  fullName            String
  owner               String
  isPrivate           Boolean           @default(true)
  defaultBranch       String            @default("main")
  htmlUrl             String
  cloneUrl            String
  sshUrl              String?
  description         String?
  lastSyncedAt        DateTime? // Last time files were synced to this repo
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deployments         Deployment[]
  githubIntegration   GitHubIntegration @relation(fields: [githubIntegrationId], references: [id], onDelete: Cascade)

  @@index([githubIntegrationId])
  @@index([projectId])
  @@index([githubRepoId])
  @@map("github_repositories")
}

model Deployment {
  id                  String             @id @default(cuid())
  projectId           String
  userId              String
  vercelIntegrationId String?
  githubRepositoryId  String?
  platform            String
  status              String             @default("pending")
  vercelDeploymentId  String?
  vercelProjectId     String?
  vercelUrl           String?
  vercelAliases       String[]
  githubCommitSha     String?
  githubBranch        String?
  buildLog            String?
  errorMessage        String?
  startedAt           DateTime?
  completedAt         DateTime?
  duration            Int?
  metadata            Json?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  githubRepository    GitHubRepository?  @relation(fields: [githubRepositoryId], references: [id])
  vercelIntegration   VercelIntegration? @relation(fields: [vercelIntegrationId], references: [id])

  @@index([projectId])
  @@index([userId])
  @@index([vercelIntegrationId])
  @@index([githubRepositoryId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
  @@map("deployments")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  name      String?
  message   String
  sentiment String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("feedback")
}

model SecurityEvent {
  id          String   @id @default(cuid())
  userId      String?
  eventType   String
  severity    String   @default("info")
  ipAddress   String?
  userAgent   String?
  email       String?
  provider    String?
  success     Boolean  @default(true)
  errorReason String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@index([ipAddress, createdAt])
  @@index([email, createdAt])
  @@index([success, createdAt])
  @@index([createdAt])
  @@map("security_events")
}

model TwoFactor {
  id          String @id @default(cuid())
  userId      String @unique
  secret      String
  backupCodes String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor")
}

// Better Auth Rate Limit table (for database storage)

model RateLimit {
  id          String @id @default(cuid())
  key         String @unique
  count       Int
  lastRequest BigInt

  @@index([key])
  @@map("rate_limit")
}

// Sandbox usage tracking for E2B
model SandboxUsage {
  id              String    @id @default(cuid())
  userId          String
  projectId       String
  sandboxId       String
  startTime       DateTime
  endTime         DateTime?
  durationMin     Int       @default(0) // Minutes of usage
  providerCostUsd Float     @default(0) // Exact E2B cost
  metadata        Json?
  createdAt       DateTime  @default(now())

  @@index([userId, createdAt])
  @@index([projectId, createdAt])
  @@index([sandboxId])
  @@map("sandbox_usage")
}

// Storage usage tracking (R2 + Database)
model StorageUsage {
  id              String   @id @default(cuid())
  userId          String
  projectId       String?
  storageType     String // "r2", "database"
  sizeGB          Decimal  @db.Decimal(10, 6)
  operations      Int      @default(0) // Read/write operations
  providerCostUsd Float    @default(0) // Exact R2/Neon cost
  billingPeriod   DateTime // When this usage was measured
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([userId, billingPeriod])
  @@index([projectId, billingPeriod])
  @@index([storageType, billingPeriod])
  @@map("storage_usage")
}

// Deployment usage tracking
model DeploymentUsage {
  id               String   @id @default(cuid())
  userId           String
  projectId        String
  deploymentId     String?
  platform         String   @default("vercel") // "vercel", "custom"
  providerCostUsd  Float    @default(0) // Exact deployment cost
  buildDurationMin Int      @default(0)
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([userId, createdAt])
  @@index([projectId, createdAt])
  @@index([platform])
  @@map("deployment_usage")
}

// ============================================================================
// RAZORPAY INTEGRATION MODELS
// ============================================================================

// Razorpay webhook event tracking
model RazorpayWebhookEvent {
  id           String             @id @default(cuid())
  eventType    String // e.g., "payment.captured", "order.paid"
  eventId      String             @unique // Razorpay's event ID for idempotency
  payload      Json // Full webhook payload
  status       WebhookEventStatus @default(PENDING)
  processedAt  DateTime?
  errorMessage String?
  retryCount   Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([eventType])
  @@index([status])
  @@index([createdAt])
  @@map("razorpay_webhook_events")
}

// ============================================================================
// USER MEMORY SYSTEM
// ============================================================================
// AI-powered memory system that learns from user interactions

model UserMemory {
  id         String    @id @default(cuid())
  userId     String
  category   String // "preference", "skill", "project_context", "workflow", "style", "technical", "personal"
  title      String // Short title for the memory
  content    String    @db.Text // Detailed memory content
  source     String // "conversation", "explicit", "inferred", "system"
  projectId  String? // Optional: link to specific project
  importance Int       @default(5) // 1-10: how important/relevant this memory is
  confidence Float     @default(1.0) // 0-1: how confident we are about this memory
  useCount   Int       @default(0) // How many times this memory has been referenced
  lastUsedAt DateTime? // When was this memory last used
  metadata   Json? // Additional context (tags, related memories, etc.)
  isActive   Boolean   @default(true) // Can be deactivated without deletion
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, category])
  @@index([userId, isActive])
  @@index([userId, importance])
  @@index([userId, lastUsedAt])
  @@index([projectId])
  @@map("user_memories")
}

model MemoryCategory {
  id          String   @id @default(cuid())
  name        String   @unique // "preference", "skill", etc.
  displayName String // User-friendly name
  description String // What this category tracks
  icon        String? // Optional icon identifier
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([sortOrder])
  @@map("memory_categories")
}

// ============================================================================
// MULTI-AGENT ORCHESTRATION SYSTEM (PHASE 3)
// ============================================================================
// Orchestrator agent manages project lifecycle and delegates to coding agent

model AgentSession {
  id           String   @id @default(cuid())
  userId       String
  projectId    String?
  // Session state (stores OrchestratorState)
  sessionData  Json
  // Conversation tracking
  messageCount Int      @default(0)
  lastMessage  String?  @db.Text
  // Status
  status       String   @default("active") // active, paused, completed, expired
  // Timestamps
  createdAt    DateTime @default(now())
  lastActive   DateTime @updatedAt
  expiresAt    DateTime
  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks        Task[]

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([expiresAt])
  @@index([userId, status])
  @@map("agent_sessions")
}

model Task {
  id           String       @id @default(cuid())
  sessionId    String
  projectId    String?
  // Task details (HIGH-LEVEL ONLY - setup, initialize, implement, build, preview)
  phase        String // setup, initialize, implement, build, preview
  description  String       @db.Text
  status       String       @default("pending") // pending, in-progress, completed, failed
  // Execution
  assignedTo   String       @default("coding-agent") // orchestrator, coding-agent
  tier         String       @default("fast") // fast, expert
  // Dependencies
  dependsOn    String[] // Array of task IDs
  // Results
  result       Json? // TaskResult
  errorMessage String?      @db.Text
  // Metadata
  attempts     Int          @default(0)
  maxAttempts  Int          @default(3)
  // Timestamps
  createdAt    DateTime     @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  // Relations
  session      AgentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([projectId])
  @@index([status])
  @@index([sessionId, status])
  @@map("tasks")
}

// ============================================================================
// SUPPORT MESSAGING SYSTEM
// ============================================================================
// Admin support chat system for user communication

model SupportMessage {
  id          String   @id @default(cuid())
  userId      String // The user this conversation is with
  content     String   @db.Text
  isFromAdmin Boolean  @default(false)
  adminId     String? // The admin who sent the message (if isFromAdmin)
  isRead      Boolean  @default(false)
  metadata    Json? // Additional data (attachments, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  // Relations
  user        User     @relation("UserSupportMessages", fields: [userId], references: [id], onDelete: Cascade)
  admin       User?    @relation("AdminSupportMessages", fields: [adminId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([isRead])
  @@index([isFromAdmin])
  @@map("support_messages")
}

// ============================================================================
// AI MODEL CONFIGURATION SYSTEM
// ============================================================================
// Database-driven AI model management with full admin CRUD capabilities
// Supports multiple providers: Anthropic, OpenAI, Google, X-AI, OpenRouter

enum AIModelProvider {
  ANTHROPIC
  OPENAI
  GOOGLE
  XAI
  OPENROUTER
}

enum AIModelTier {
  FAST
  EXPERT
}

enum AIModelUseCase {
  ORCHESTRATOR
  MEMORY
  CODING
  IMAGE_GENERATION
  VIDEO_GENERATION
}

enum AIModelInputType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  PDF
  DOCUMENT
}

enum AIModelOutputType {
  TEXT
  CODE
  IMAGE
  AUDIO
  VIDEO
  STRUCTURED_DATA
}

model AIModel {
  id           String               @id // OpenRouter format: "provider/model-name" (e.g., "anthropic/claude-sonnet-4.5")
  name         String // Direct provider API name (e.g., "claude-sonnet-4-5" for Anthropic)
  displayName  String
  provider     AIModelProvider
  tier         AIModelTier
  description  String
  useCase      AIModelUseCase
  // Status flags
  isEnabled    Boolean              @default(true) // Can be disabled without deletion
  isDefault    Boolean              @default(false) // Is this the default for its use case
  isSystem     Boolean              @default(false) // System models cannot be user-selected (e.g., orchestrator)
  // Display order
  sortOrder    Int                  @default(0)
  // Relations
  capabilities AIModelCapabilities?
  pricing      AIModelPricing?
  // Metadata
  metadata     Json? // Additional provider-specific data
  // Audit fields
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  createdBy    String? // Admin who created this
  updatedBy    String? // Admin who last updated this

  @@index([provider])
  @@index([tier])
  @@index([useCase])
  @@index([isEnabled])
  @@index([isDefault])
  @@index([useCase, isEnabled])
  @@index([useCase, isDefault])
  @@map("ai_models")
}

model AIModelCapabilities {
  id                      String              @id @default(cuid())
  modelId                 String              @unique
  // Input/Output types (stored as arrays of enum values)
  supportedInputs         AIModelInputType[]
  supportedOutputs        AIModelOutputType[]
  // Context and features
  maxContextLength        Int? // Maximum context window in tokens
  supportsStreaming       Boolean             @default(true)
  supportsSystemPrompts   Boolean             @default(true)
  supportsWebSearch       Boolean             @default(false)
  supportsFunctionCalling Boolean             @default(true)
  supportsJsonMode        Boolean             @default(true)
  // Relations
  model                   AIModel             @relation(fields: [modelId], references: [id], onDelete: Cascade)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  @@index([modelId])
  @@map("ai_model_capabilities")
}

model AIModelPricing {
  id                       String   @id @default(cuid())
  modelId                  String   @unique
  // STANDARD TOKEN PRICING (Required) - USD per 1M tokens
  inputTokens              Float // USD per 1M input tokens
  outputTokens             Float // USD per 1M output tokens
  // LONG CONTEXT PRICING (Optional)
  longContextThreshold     Int? // Context size threshold (e.g., 200000)
  inputTokensLongContext   Float? // USD per 1M input tokens above threshold
  outputTokensLongContext  Float? // USD per 1M output tokens above threshold
  // PROMPT CACHING (Optional)
  cacheCreation            Float? // USD per 1M cache creation tokens
  cacheRead                Float? // USD per 1M cache read tokens
  cacheCreationLongContext Float? // USD per 1M cache creation (long context)
  cacheReadLongContext     Float? // USD per 1M cache read (long context)
  cacheDuration            String? // e.g., "5-min", "1-hour"
  // MULTIMODAL INPUTS (Optional)
  imageInputTokens         Float? // USD per 1M image input tokens
  audioInputTokens         Float? // USD per 1M audio input tokens
  videoInputTokens         Float? // USD per 1M video input tokens
  // MULTIMODAL OUTPUTS (Optional)
  audioOutputTokens        Float? // USD per 1M audio output tokens
  // GENERATED CONTENT OUTPUT (Optional)
  images                   Float? // USD per 1K images generated
  videoSeconds             Float? // USD per second of video generated
  // TOOL/FEATURE CHARGES (Optional)
  webSearchFreePerDay      Int? // Free requests per day
  webSearch                Float? // USD per 1K search requests
  mapsGroundingFreePerDay  Int? // Free requests per day
  mapsGrounding            Float? // USD per 1K grounding requests
  // Notes (for admin reference)
  pricingNotes             String?  @db.Text // Additional pricing info, discounts, etc.
  // Relations
  model                    AIModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([modelId])
  @@map("ai_model_pricing")
}

// Default model settings per use case
model AIModelDefaults {
  id        String         @id @default(cuid())
  useCase   AIModelUseCase @unique
  modelId   String // Reference to AIModel.id
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  updatedBy String? // Admin who last updated this

  @@index([useCase])
  @@map("ai_model_defaults")
}

// Audit log for model configuration changes
model AIModelAuditLog {
  id          String   @id @default(cuid())
  modelId     String? // Can be null for global settings changes
  action      String // created, updated, deleted, enabled, disabled, set_default
  changes     Json? // What changed (before/after)
  performedBy String // Admin user ID
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([modelId])
  @@index([action])
  @@index([performedBy])
  @@index([createdAt])
  @@map("ai_model_audit_logs")
}
