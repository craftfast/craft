generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String               @id @default(cuid())
  name                    String?
  email                   String               @unique
  emailVerified           DateTime?
  image                   String?
  password                String?
  verificationToken       String?              @unique
  verificationTokenExpiry DateTime?
  preferredChatPosition   String               @default("right")
  preferredTheme          String               @default("dark")
  preferredModel          String               @default("gpt-5")
  enabledModels           String[]             @default(["gpt-5-mini", "claude-haiku-4-5", "gpt-5", "claude-sonnet-4.5"])
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  passwordResetExpiry     DateTime?
  passwordResetToken      String?              @unique
  failedLoginAttempts     Int                  @default(0)
  lastFailedLoginAt       DateTime?
  lockedUntil             DateTime?
  role                    String               @default("user")
  twoFactorEnabled        Boolean              @default(false)
  twoFactorSecret         String?
  backupCodes             String[]             @default([])
  accounts                Account[]
  files                   File[]
  passwordHistory         PasswordHistory[]
  pendingAccountLinks     PendingAccountLink[] @relation("PendingAccountLinks")
  projects                Project[]
  sessions                Session[]
  subscription            UserSubscription?

  @@map("users")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  scope                 String?
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  accountId             String
  createdAt             DateTime  @default(now())
  idToken               String?
  password              String?
  providerId            String
  refreshToken          String?
  refreshTokenExpiresAt DateTime?
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  ipAddress String?
  token     String   @unique
  updatedAt DateTime @updatedAt
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verifications")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model TwoFactorPendingSession {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("two_factor_pending_sessions")
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  password  String // Hashed password
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("password_history")
}

model PendingAccountLink {
  id                String   @id @default(cuid())
  userId            String
  email             String
  provider          String
  providerAccountId String
  token             String   @unique
  expiresAt         DateTime
  createdAt         DateTime @default(now())
  user              User     @relation("PendingAccountLinks", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([token])
  @@map("pending_account_links")
}

model Project {
  id               String           @id @default(cuid())
  name             String
  description      String?
  type             String           @default("document")
  status           String           @default("active")
  visibility       String           @default("private")
  userId           String
  version          Int              @default(0)
  generationStatus String           @default("template")
  lastCodeUpdateAt DateTime?
  codeFiles        Json             @default("{}")
  preferredModel   String           @default("gpt-5")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  chatMessages     ChatMessage[]
  fileRecords      File[]           @relation("ProjectFiles")
  versions         ProjectVersion[]
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("projects")
}

model File {
  id            String       @id @default(cuid())
  userId        String
  projectId     String?
  chatMessageId String?
  path          String?
  r2Key         String       @unique
  r2Url         String
  fileName      String
  mimeType      String?
  size          Int
  purpose       String       @default("upload")
  version       Int          @default(1)
  isDeleted     Boolean      @default(false)
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  chatMessage   ChatMessage? @relation(fields: [chatMessageId], references: [id])
  project       Project?     @relation("ProjectFiles", fields: [projectId], references: [id])
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([chatMessageId])
  @@index([r2Key])
  @@index([purpose])
  @@index([projectId, path])
  @@index([chatMessageId, createdAt])
  @@map("files")
}

model ChatMessage {
  id          String   @id @default(cuid())
  projectId   String
  role        String
  content     String
  fileChanges Json?
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  files       File[]

  @@index([projectId])
  @@index([projectId, createdAt])
  @@map("chat_messages")
}

model ProjectVersion {
  id            String   @id @default(cuid())
  projectId     String
  version       Int
  name          String?
  codeFiles     Json
  chatMessageId String?
  isBookmarked  Boolean  @default(false)
  isPublished   Boolean  @default(false)
  createdAt     DateTime @default(now())
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId, createdAt])
  @@index([projectId, isBookmarked])
  @@index([projectId, isPublished])
  @@map("project_versions")
}

model Plan {
  id              String             @id @default(cuid())
  name            String             @unique
  displayName     String
  description     String?
  priceMonthlyUsd Float
  features        Json
  maxProjects     Int?
  dailyCredits    Int?
  monthlyCredits  Int?
  isActive        Boolean            @default(true)
  sortOrder       Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  subscriptions   UserSubscription[]

  @@index([name])
  @@index([isActive])
  @@map("plans")
}

model UserSubscription {
  id                 String        @id @default(cuid())
  userId             String        @unique
  planId             String
  status             String        @default("active")
  currentPeriodStart DateTime      @default(now())
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean       @default(false)
  cancelledAt        DateTime?
  polarCheckoutId    String?
  polarPaymentId     String?
  dailyCreditsUsed   Decimal       @default(0) @db.Decimal(10, 2)
  lastCreditReset    DateTime      @default(now())
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  invoices           Invoice[]
  usageRecords       UsageRecord[]
  plan               Plan          @relation(fields: [planId], references: [id])
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("user_subscriptions")
}

model AICreditUsage {
  id              String   @id @default(cuid())
  userId          String
  projectId       String
  model           String
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  costUsd         Float
  creditsUsed     Decimal  @default(0) @db.Decimal(10, 4)
  modelMultiplier Float    @default(1.0)
  endpoint        String?
  callType        String   @default("agent")
  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@index([projectId, createdAt])
  @@index([model, createdAt])
  @@index([callType, createdAt])
  @@index([createdAt])
  @@map("ai_credit_usage")
}

model UsageRecord {
  id                 String           @id @default(cuid())
  userId             String
  subscriptionId     String
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  aiCreditsUsed      Decimal          @default(0) @db.Decimal(10, 2)
  aiCostUsd          Float            @default(0)
  totalCostUsd       Float            @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  subscription       UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, billingPeriodStart])
  @@index([userId, billingPeriodStart])
  @@index([billingPeriodEnd])
  @@map("usage_records")
}

model Invoice {
  id                 String           @id @default(cuid())
  userId             String
  subscriptionId     String
  invoiceNumber      String           @unique
  status             String           @default("draft")
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  subscriptionFeeUsd Float            @default(0)
  aiUsageCostUsd     Float            @default(0)
  subtotalUsd        Float            @default(0)
  taxUsd             Float            @default(0)
  totalUsd           Float            @default(0)
  currency           String           @default("USD")
  polarCheckoutId    String?
  polarPaymentId     String?
  paidAt             DateTime?
  dueDate            DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  subscription       UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([billingPeriodStart])
  @@index([dueDate])
  @@map("invoices")
}

model PaymentTransaction {
  id              String   @id @default(cuid())
  userId          String
  invoiceId       String?
  amount          Float
  currency        String   @default("USD")
  status          String
  paymentMethod   String   @default("polar")
  polarCheckoutId String?
  polarPaymentId  String?
  polarSignature  String?
  failureReason   String?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([invoiceId])
  @@index([status])
  @@index([polarCheckoutId])
  @@index([polarPaymentId])
  @@index([createdAt])
  @@map("payment_transactions")
}

model VercelIntegration {
  id             String       @id @default(cuid())
  userId         String       @unique
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  vercelUserId   String?
  vercelTeamId   String?
  email          String?
  username       String?
  scopes         String[]
  isActive       Boolean      @default(true)
  lastSyncAt     DateTime?
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deployments    Deployment[]

  @@index([userId])
  @@index([isActive])
  @@map("vercel_integrations")
}

model GitHubIntegration {
  id             String             @id @default(cuid())
  userId         String             @unique
  accessToken    String
  refreshToken   String?
  tokenExpiresAt DateTime?
  githubUserId   Int
  login          String
  email          String?
  name           String?
  avatarUrl      String?
  scopes         String[]
  isActive       Boolean            @default(true)
  lastSyncAt     DateTime?
  metadata       Json?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  repositories   GitHubRepository[]

  @@index([userId])
  @@index([githubUserId])
  @@index([isActive])
  @@map("github_integrations")
}

model GitHubRepository {
  id                  String            @id @default(cuid())
  githubIntegrationId String
  projectId           String?
  githubRepoId        Int               @unique
  name                String
  fullName            String
  owner               String
  isPrivate           Boolean           @default(true)
  defaultBranch       String            @default("main")
  htmlUrl             String
  cloneUrl            String
  sshUrl              String?
  description         String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deployments         Deployment[]
  githubIntegration   GitHubIntegration @relation(fields: [githubIntegrationId], references: [id], onDelete: Cascade)

  @@index([githubIntegrationId])
  @@index([projectId])
  @@index([githubRepoId])
  @@map("github_repositories")
}

model Deployment {
  id                  String             @id @default(cuid())
  projectId           String
  userId              String
  vercelIntegrationId String?
  githubRepositoryId  String?
  platform            String
  status              String             @default("pending")
  vercelDeploymentId  String?
  vercelProjectId     String?
  vercelUrl           String?
  vercelAliases       String[]
  githubCommitSha     String?
  githubBranch        String?
  buildLog            String?
  errorMessage        String?
  startedAt           DateTime?
  completedAt         DateTime?
  duration            Int?
  metadata            Json?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  githubRepository    GitHubRepository?  @relation(fields: [githubRepositoryId], references: [id])
  vercelIntegration   VercelIntegration? @relation(fields: [vercelIntegrationId], references: [id])

  @@index([projectId])
  @@index([userId])
  @@index([vercelIntegrationId])
  @@index([githubRepositoryId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
  @@map("deployments")
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  name      String?
  message   String
  sentiment String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("feedback")
}

model SecurityEvent {
  id          String   @id @default(cuid())
  userId      String?
  eventType   String
  severity    String   @default("info")
  ipAddress   String?
  userAgent   String?
  email       String?
  provider    String?
  success     Boolean  @default(true)
  errorReason String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@index([ipAddress, createdAt])
  @@index([email, createdAt])
  @@index([success, createdAt])
  @@index([createdAt])
  @@map("security_events")
}
